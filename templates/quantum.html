<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PolicyNav â€” Quantum</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body>
  <header class="navbar">
    <div class="logo" onclick="window.location.href='/'">PolicyNav</div>
    <nav>
      <ul class="nav-links">
        <li><a href="/classical" {% if 'classical' in request.path %}style="color:#d1a9ff;"{% endif %}>Classical</a></li>
        <li><a href="/quantum" {% if 'quantum' in request.path %}style="color:#d1a9ff;"{% endif %}>Quantum</a></li>
        <form action="/logout" method="get" style="display:inline;">
        <button type="submit" class="logout-btn">Logout</button>
      </form>
      </ul>
    </nav>
  </header>

  <form class="search" method="post" action="/quantum_search">
    <input type="text" name="query" placeholder="Search policies..." value="{{ query }}" required />
    <label for="top_k">Results</label>
    <input type="range" id="top_k" name="top_k" min="1" max="10" value="{{ top_k or 5 }}" oninput="this.nextElementSibling.value=this.value">
    <output>{{ top_k or 5 }}</output>
    <button type="submit" class="purple-btn">Search</button>
  </form>

  {% if results %}
  <div class="results-container">
    {% for r in results %}
      <div class="result-card">
        <h3>{{ r.title }} <small style="color:#666">({{ r.policy_id }})</small></h3>
        <p><b>Region:</b> {{ r.region }} | <b>Year:</b> {{ r.year }} | <b>Status:</b> {{ r.status }}</p>
        <p>{{ r.summary }}</p>
        <p style="color:#6c5ce7;font-weight:700;margin-top:8px">Score: {{ "%.4f"|format(r.score) }}</p>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="dashboard">
    <h2>Quantum Search Insights...</h2>
    <div class="dashboard-grid">
      <div class="chart-box"><canvas id="statusChart"></canvas></div>
      <div class="chart-box"><canvas id="regionChart"></canvas></div>
      <div class="chart-box"><canvas id="scoreChart"></canvas></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const data = JSON.parse('{{ results|default([])|tojson }}');
    const statusCounts={}, regionCounts={}, scores=[];

    data.forEach(r=>{
      const s=r.status||"Unknown";
      const reg=r.region||"Unknown";
      statusCounts[s]=(statusCounts[s]||0)+1;
      regionCounts[reg]=(regionCounts[reg]||0)+1;
      scores.push(Number(r.score||0));
    });

    const statusLabels=Object.keys(statusCounts).length?Object.keys(statusCounts):['Implemented','Planned','Draft'];
    const statusData=Object.values(statusCounts).length?Object.values(statusCounts):[3,2,1];
    const regionLabels=Object.keys(regionCounts).length?Object.keys(regionCounts):['North','South','East','West'];
    const regionData=Object.values(regionCounts).length?Object.values(regionCounts):[4,3,2,1];
    const scoreData=scores.length?scores:[0.12,0.24,0.31,0.41];

    new Chart(statusChart,{type:'doughnut',data:{labels:statusLabels,datasets:[{data:statusData,backgroundColor:['#7c3aed','#c4b5fd','#ddd6fe']}]},options:{plugins:{title:{display:true,text:'Status Breakdown'}}}});
    new Chart(regionChart,{type:'bar',data:{labels:regionLabels,datasets:[{label:'Policies',data:regionData,backgroundColor:'#a78bfa'}]},options:{plugins:{title:{display:true,text:'Policies by Region'}},scales:{y:{beginAtZero:true}}}});
    new Chart(scoreChart,{type:'line',data:{labels:scoreData.map((_,i)=>`R${i+1}`),datasets:[{label:'Similarity',data:scoreData,fill:true,borderColor:'#7c3aed',backgroundColor:'rgba(124,58,237,0.2)',tension:0.3}]},options:{plugins:{title:{display:true,text:'Similarity Scores'}},scales:{y:{beginAtZero:true}}}});
  </script>
</body>
</html>
